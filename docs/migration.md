# ğŸ“˜ Database Migrations Guide

## ğŸ“„ Overview

Schedium uses **Alembic** for database schema version control. This guide explains how to work with migrations efficiently and safely.

---

## âš™ï¸ Initial Setup

1. **Install dependencies**

   ```bash
   pip install -r requirements.txt
````

2. **Create initial migration** (only once)

   ```bash
   python scripts/create_initial_migration.py
   ```

---

## ğŸ› ï¸ Common Tasks

### â• Creating a Migration

After modifying your models:

**Using Alembic directly**

```bash
alembic revision --autogenerate -m "Add new field to instructor"
```

**Using utility script**

```bash
python scripts/migration_utils.py create "Add new field to instructor"
```

---

### ğŸš€ Applying Migrations

**Upgrade to latest**

```bash
alembic upgrade head
```

**Using utility script**

```bash
python scripts/migration_utils.py upgrade
```

---

### ğŸ” Checking Migration Status

**Current revision**

```bash
alembic current
```

**Pending migrations**

```bash
python scripts/migration_utils.py check
```

---

### â†©ï¸ Rolling Back

**Rollback one migration**

```bash
alembic downgrade -1
```

**Rollback to specific revision**

```bash
alembic downgrade abc123
```

**Using utility script**

```bash
python scripts/migration_utils.py downgrade
```

---

## âœ… Best Practices

1. **Always review autogenerated migrations**

   * Check for data loss operations
   * Verify foreign key constraints
   * Test on development database first

2. **Name migrations descriptively**

   ```bash
   alembic revision --autogenerate -m "Add hour_limit to contract table"
   ```

3. **Never edit existing migrations**

   * Create a new migration instead
   * *Exception:* fixing typos in migration messages

4. **Test migrations both ways**

   ```bash
   alembic upgrade head
   alembic downgrade -1
   alembic upgrade head
   ```

5. **Handle data migrations carefully**

   * Add data transformations in migration files when needed
   * Always backup before running destructive migrations

---

## ğŸ§° Troubleshooting

### ğŸ› "Can't locate revision" error

```bash
alembic current
alembic stamp head
```

### â›” "Target database is not up to date"

```bash
alembic upgrade head
```

### ğŸ¤ Conflicts in team development

* Pull latest changes
* Merge migration branches if needed
* Create a merge migration:

  ```bash
  alembic merge -m "Merge branch migrations"
  ```

---

## ğŸš¢ Production Deployments

* Backup database before migrations
* Test on staging environment first
* Use transactions when possible
* Have rollback plan ready

### ğŸ“œ Deployment Script Example

```bash
#!/bin/bash
# deploy_migrations.sh

# Backup
mysqldump schedium_database > backup_$(date +%Y%m%d_%H%M%S).sql

# Apply migrations
alembic upgrade head

# Verify
alembic current
```

---

## ğŸ§¾ 8. Comandos de uso rÃ¡pido (Makefile)

Crear un archivo `Makefile` en la raÃ­z del proyecto:

```makefile
# Database migrations
.PHONY: db-upgrade db-downgrade db-current db-history db-create db-check init-db

db-upgrade:
	@echo "â¬†ï¸  Upgrading database..."
	alembic upgrade head

db-downgrade:
	@echo "â¬‡ï¸  Downgrading database..."
	alembic downgrade -1

db-current:
	@echo "ğŸ“ Current revision:"
	alembic current

db-history:
	@echo "ğŸ“œ Migration history:"
	alembic history

db-create:
	@echo "ğŸ“ Creating migration..."
	@read -p "Enter migration message: " msg; \
	alembic revision --autogenerate -m "$$msg"

db-check:
	@echo "ğŸ” Checking for changes..."
	alembic check

init-db:
	@echo "ğŸš€ Initializing database..."
	python scripts/create_initial_migration.py
```
