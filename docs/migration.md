# 📘 Database Migrations Guide

## 📄 Overview

Schedium uses **Alembic** for database schema version control. This guide explains how to work with migrations efficiently and safely.

---

## ⚙️ Initial Setup

1. **Install dependencies**

   ```bash
   pip install -r requirements.txt
````

2. **Create initial migration** (only once)

   ```bash
   python scripts/create_initial_migration.py
   ```

---

## 🛠️ Common Tasks

### ➕ Creating a Migration

After modifying your models:

**Using Alembic directly**

```bash
alembic revision --autogenerate -m "Add new field to instructor"
```

**Using utility script**

```bash
python scripts/migration_utils.py create "Add new field to instructor"
```

---

### 🚀 Applying Migrations

**Upgrade to latest**

```bash
alembic upgrade head
```

**Using utility script**

```bash
python scripts/migration_utils.py upgrade
```

---

### 🔎 Checking Migration Status

**Current revision**

```bash
alembic current
```

**Pending migrations**

```bash
python scripts/migration_utils.py check
```

---

### ↩️ Rolling Back

**Rollback one migration**

```bash
alembic downgrade -1
```

**Rollback to specific revision**

```bash
alembic downgrade abc123
```

**Using utility script**

```bash
python scripts/migration_utils.py downgrade
```

---

## ✅ Best Practices

1. **Always review autogenerated migrations**

   * Check for data loss operations
   * Verify foreign key constraints
   * Test on development database first

2. **Name migrations descriptively**

   ```bash
   alembic revision --autogenerate -m "Add hour_limit to contract table"
   ```

3. **Never edit existing migrations**

   * Create a new migration instead
   * *Exception:* fixing typos in migration messages

4. **Test migrations both ways**

   ```bash
   alembic upgrade head
   alembic downgrade -1
   alembic upgrade head
   ```

5. **Handle data migrations carefully**

   * Add data transformations in migration files when needed
   * Always backup before running destructive migrations

---

## 🧰 Troubleshooting

### 🐛 "Can't locate revision" error

```bash
alembic current
alembic stamp head
```

### ⛔ "Target database is not up to date"

```bash
alembic upgrade head
```

### 🤝 Conflicts in team development

* Pull latest changes
* Merge migration branches if needed
* Create a merge migration:

  ```bash
  alembic merge -m "Merge branch migrations"
  ```

---

## 🚢 Production Deployments

* Backup database before migrations
* Test on staging environment first
* Use transactions when possible
* Have rollback plan ready

### 📜 Deployment Script Example

```bash
#!/bin/bash
# deploy_migrations.sh

# Backup
mysqldump schedium_database > backup_$(date +%Y%m%d_%H%M%S).sql

# Apply migrations
alembic upgrade head

# Verify
alembic current
```

---

## 🧾 8. Comandos de uso rápido (Makefile)

Crear un archivo `Makefile` en la raíz del proyecto:

```makefile
# Database migrations
.PHONY: db-upgrade db-downgrade db-current db-history db-create db-check init-db

db-upgrade:
	@echo "⬆️  Upgrading database..."
	alembic upgrade head

db-downgrade:
	@echo "⬇️  Downgrading database..."
	alembic downgrade -1

db-current:
	@echo "📍 Current revision:"
	alembic current

db-history:
	@echo "📜 Migration history:"
	alembic history

db-create:
	@echo "📝 Creating migration..."
	@read -p "Enter migration message: " msg; \
	alembic revision --autogenerate -m "$$msg"

db-check:
	@echo "🔍 Checking for changes..."
	alembic check

init-db:
	@echo "🚀 Initializing database..."
	python scripts/create_initial_migration.py
```
